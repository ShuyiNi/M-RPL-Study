#!/usr/bin/env python3
from argparse import ArgumentParser
from datetime import datetime, timezone
from pathlib import Path
from subprocess import run

# Configure
PROJECT_ROOT = Path(__file__).absolute().parent.parent
CONTIKI = PROJECT_ROOT / "contiki-ng"
COOJA = CONTIKI / "tools/cooja/dist/cooja.jar"

# Parse arguments
parser = ArgumentParser()
parser.add_argument("config", type=Path)
parser.add_argument("-s", "--seed", type=int, default=0)
parser.add_argument("-t", "--tag", default=None)
args = parser.parse_args()
config = args.config.absolute()
seed = args.seed
tag = args.tag

# Prepare log directory
if tag is None:
    tag = datetime.now(timezone.utc).strftime("%Y%m%d-%H%M%S")
work_dir = config.parent
log_dir = work_dir / "log-files" / f"log-{tag}"
log_dir.mkdir(parents=True, exist_ok=True)

# Run
cmd = f"java -Xshare:on -jar {COOJA} -nogui={config} -contiki={CONTIKI} -random-seed={seed}"
run(cmd, shell=True, cwd=log_dir)

import parse_log
import os
parse_log.analyse_data("COOJA.testlog", base_dir=os.fspath(log_dir), time_interval_secs=[0.5, 1, 1.5, 2, 5, 10])
